!function(a,b,c,d){"use strict";var e=b.sync,f={};b.$=b.$||c,b.sync=function(a,c,f){return d.isUndefined(f.wait)&&(f.wait=!0),e.apply(b,[a,c,f])},f.baseUrl="",f.Utils={},f.Utils.getUrl=function(a){return"/"===a.charAt(0)&&(a=a.substr(1)),f.baseUrl+"/"+a},f.Utils.request=function(a){var c={data:a.data||{t:(new Date).getTime()}};return!c.data||"POST"!==a.type&&"PUT"!==a.type||(c.data=JSON.stringify(c.data),c.contentType="application/json"),c=d.extend(a,c),b.ajax(c)};var g=function(a,c){c=c||{};var e,f,g=a,h=c.limit,i=!!h&&c.offset,j=c.page||1,k=c.perPage||30,l=c.customUrlParams||{},m=c.filterValues||{},n=c.filterDefinition,o=c.sortOrder,p=function(a){return JSON.parse(JSON.stringify(a))};this.filterValues={},this.customUrlParams={},this.fields=c.fields,this.filterIsSet=!1,this.getRequestParams=function(a,b,c){if(c=c||{},c.params=c.params||{},"read"===a){this.filterValues=d.extend({},this.getInitialFilterValues(),this.filterValues);var e=this.getFilters();return e&&(c.params.filter=e),JSON.stringify(e)!==JSON.stringify(f)&&(j=1),f=e,k&&j&&(h||d.isUndefined(h))&&(c.params.limit=k,c.params.offset=j>1?k*(j-1):0),o&&(c.params.sortOrder=o),(h||i)&&(c.params.limit=h,c.params.offset=i),h===!1&&delete c.params.limit,this.fields&&(c.params.field=this.fields),this.customUrlParams&&d.extend(c.params,d.result(this,"customUrlParams")),c.params.getNonpagedCount=!0,c}},this.getInitialFilterValues=function(){return m},this.setInitialFilterValues=function(a){for(var b in a)this.filterValues[b]===m[b]&&(this.filterValues[b]=a[b]);d.extend(m,a),this.filterValues=d.extend({},m,this.filterValues)},this.setLimit=function(a){h=a,i=i||0},this.setTotalAmount=function(a){e=a},this.getTotalAmount=function(){return e},this.loadPreviousPage=function(){return j-=1,g.fetch({remove:!1})},this.hasPreviousPage=function(){return j>=1},this.loadNextPage=function(){return j+=1,g.fetch({remove:!1})},this.hasNextPage=function(){return e&&e>g.length},this.getPage=function(){return j},this.setPage=function(a){j=a},this.getTotalPages=function(){return Math.floor(e/k)},this.setSortOrder=function(b){j=1,o=b,a.trigger("change:sortOrder",b)},this.getSortOrder=function(){return o},this.setFilters=function(b){c=c||{},d.forEach(b,function(b,e){if(!d.has(this.filterValues,e))throw new Error("Filter named '"+e+"' not found, did you add it to filterValues of the model?");this.filterValues[e]=b;var f={};f[e]=b,!d.isUndefined(c.silent)&&c.silent||a.trigger("change:filterValue",f)},this),this.setPage(1),this.filterIsSet=!0},this.getFilters=function(){if(d.isFunction(n))return n.apply(this)},this.resetFilters=function(){this.filterValues=p(m),this.customUrlParams=l,this.filterIsSet=!1},function(){if(!g instanceof b.Collection)throw new Error("First parameter has to be the instance of a collection");c.filterValues&&(m=p(c.filterValues)),this.resetFilters()}.bind(this)()},h=function(a,c){var d=a,e=c||{},g=!0,h=e.isSingleSelection||!1,i=e.addPreSelectedToCollection||!1,j=e.unSelectOnRemove,k=c.preSelected,l=!!c.preSelected,m=new(f.Collection.extend({selectable:!1,filterable:!1})),n=function(){if(k instanceof b.Model)this.preSelectModel(k);else{if(!(k instanceof b.Collection))throw new Error("The option preSelected has to be either a Backbone Model or Collection");this.preSelectCollection(k)}},o=function(a){m.get(a)||this.select(a)},p=function(a){m.get(a)&&this.unSelect(a)},q=function(a,b){b=b||{},(b.unset||!a.id||a.id.length<1)&&this.unSelect(a)},r=function(a){a.selectable.off("change:select",o,this),a.selectable.on("change:select",o,this)},s=function(a){a.selectable.off("change:unselect",p,this),a.selectable.on("change:unselect",p,this)},t=function(a,b){if(a&&a.selectable){var c=m.get(a);c?(d.get(a)?(a.selectable.isInCollection=!0,c.selectable.isInCollection=!0):(a.selectable.isInCollection=!1,c.selectable.isInCollection=!1),a.selectable.select(b),c.selectable.select(b)):a.selectable.unSelect(b),r.call(this,a),s.call(this,a)}},u=function(a,b){l&&(this.isSingleSelection()?k=b:(k.remove(a,{silent:!0}),k.add(b,{silent:!0})))},v=function(a){var b=this.getSelected().get(a);b&&(this.unSelect(b,{silent:!0}),this.select(a,{silent:!0}),u.call(this,b,a),t.call(this,b,{silent:!0}))};this.getSelected=function(){return m},this.getDisabled=function(){var a=new b.Collection;return g&&d.each(function(b){b.selectable&&b.selectable.isDisabled()&&a.add(b)}),a},this.select=function(a,c){if(c=c||{},!(a instanceof b.Model))throw new Error("The first argument has to be a Backbone Model");a instanceof d.model||(a=new d.model(a.toJSON())),!a.selectable||a.selectable.isDisabled()&&!c.force||(h&&this.unSelectAll(),d.get(a)&&(a=d.get(a)),a.on("change",q,this),m.add(a,c),t.call(this,a,c),c.silent||this.trigger("change change:add",a,this))},this.selectAll=function(){d.each(function(a){this.select(a)},this)},this.unSelect=function(a,b){b=b||{},a.off("change",q,this),m.remove(a,b),t.call(this,a,b),b.silent||this.trigger("change change:remove",a,this)},this.unSelectAll=function(){this.getSelected().secureEach(function(a){this.unSelect(a)},this)},this.toggleSelectAll=function(){this.allSelected()?this.unSelectAll():this.selectAll()},this.allSelected=function(){var a=this.getDisabled().length;return this.getSelected().length===d.length-a},this.allDisabled=function(){return this.getDisabled().length===d.length},this.isSingleSelection=function(){return h},this.setSingleSelection=function(a){if(k instanceof b.Model){if(!a)throw new Error("isSingleSelection can not be set to false when preselected is a model!");h=!0}else h=a},this.reset=function(){this.unSelectAll(),n.call(this)},this.preSelectModel=function(a){a.id&&(l=!0,!d.get(a)&&i?d.add(a):d.get(a)&&(a=d.get(a)),this.select(a,{force:!0,silent:!0}))},this.preSelectCollection=function(a){a.each(function(a){this.preSelectModel(a)},this),a.on("add",function(a){this.preSelectModel(a)},this),a.on("remove",function(a){this.unSelect(a)},this)},this.setCollectionFromSelection=function(a){var c=this.getSelected();if(!(a instanceof b.Collection))throw new Error("[Selectable] The passed collection is not an instance of mwUI.Backbone.Collection");return a.replace(c.toJSON()),a},this.setModelFromSelection=function(a){var c=this.getSelected();if(!(a instanceof b.Model))throw new Error("[Selectable] The passed model is not an instance of Backbone.Model");return 0===c.length?a.clear():a.set(c.first().toJSON()),a},this.useSelectionFor=function(a){return a instanceof b.Model?this.setModelFromSelection(a):a instanceof b.Collection?this.setCollectionFromSelection(a):void 0};var w=function(){if(!(d instanceof b.Collection))throw new Error("The first parameter has to be from type Backbone.Collection");d.on("add",function(a){g=a.selectable.hasDisabledFn,t.call(this,a),v.call(this,a)},this),d.on("remove",function(a){j?this.unSelect(a):t.call(this,a)},this),d.on("reset",function(){j?this.unSelectAll():this.getSelected().each(function(a){t.call(this,a)},this)},this),k instanceof b.Model?this.setSingleSelection(!0):this.setSingleSelection(e.isSingleSelection||!1),l&&n.call(this)}.bind(this);w.call(this)};f.CollectionSelectable=h;var i=function(a,c){var d=a,e=c.selected||!1;this.isInCollection=!1,this.hasDisabledFn="function"==typeof c.isDisabled||!1,this.isDisabled=function(){return!!this.hasDisabledFn&&c.isDisabled.apply(a,arguments)},this.isSelected=function(){return e},this.select=function(b){b=b||{},this.isDisabled()&&!b.force||this.isSelected()||(e=!0,b.silent||this.trigger("change change:select",a,this))},this.unSelect=function(b){b=b||{},this.isSelected()&&(e=!1,b.silent||this.trigger("change change:unselect",a,this))},this.toggleSelect=function(){this.isSelected()?this.unSelect():this.select()};var f=function(){if(!(d instanceof b.Model))throw new Error("First parameter has to be the instance of a model")};f.call(this)};f.ModelSelectable=i;var i=f.ModelSelectable||{},h=f.CollectionSelectable||{};d.extend(i.prototype,b.Events),d.extend(h.prototype,b.Events);var j=function(a,c){if(a instanceof b.Model)return new i(a,c);if(a instanceof b.Collection)return new h(a,c);throw new Error("SelectableFactory: instance has to be either a model or a collection")};f.SelectableFactory=j;var j=j||{},k=b.Model.extend({idAttribute:"uuid",selectable:!0,selectableOptions:{},queryParameter:null,constructor:function(a,b){this.on("destroy",function(){this.collection&&this.collection.filterable&&this.collection.filterable.getTotalAmount()>0&&this.collection.filterable.setTotalAmount(this.collection.filterable.getTotalAmount()-1)},this),this.selectable&&(this.selectable=new j(this,d.result(this,"selectableOptions"))),"string"==typeof this.endpoint&&this.setEndpoint(this.endpoint);var c=a||{};b=b||{},this.cid=d.uniqueId("c"),this.attributes={},b.collection&&(this.collection=b.collection),this._setNesting(c,b),this.changed={},this.initialize.apply(this,arguments)},_setNesting:function(a,b){b=b||{};var c=this.prepare();this.set(c),b.parse&&(a=this.parse(a,b)||{}),a=d.defaults({},a,c,d.result(this,"defaults")),this.set(a,b)},prepare:function(){return{}},setQueryParameter:function(a,b){this.queryParameter=this.queryParameter||{},"string"==typeof a&&(this.queryParameter[a]=b)},removeQueryParameter:function(a){this.queryParameter&&a&&this.queryParameter[a]&&delete this.queryParameter[a]},getEndpoint:function(){return this.urlRoot()},setEndpoint:function(a){this.urlRoot=function(){return"/"===f.baseUrl.slice(-1)&&"/"===a[0]?f.baseUrl+a.substr(1):"/"!==f.baseUrl.slice(-1)&&"/"!==a[0]?f.baseUrl+"/"+a:f.baseUrl+a}},parse:function(a){return a&&a.data&&a.data.results&&a.data.results.length>=0&&"undefined"!=typeof a.data.results[0]?a.data.results[0]:a&&a.data?a.data:a},url:function(){var a=b.Model.prototype.url.apply(this,arguments);return this.queryParameter&&(a+="?"+b.$.param(d.result(this,"queryParameter"))),a},beforeSave:function(a){return a},recursiveBeforeSave:function(a){var c=this.beforeSave(a),e=function(a){if(a instanceof b.Model&&"function"==typeof a.recursiveBeforeSave)return a.recursiveBeforeSave(a.toJSON());if(a instanceof b.Model&&"function"!=typeof a.recursiveBeforeSave)return a.toJSON();if(a instanceof f.EnumerableCollection)return a.toJSON();if(a instanceof b.Collection){var c=[];return a.each(function(a){var b=e(a);c.push(b)}),c}if(d.isArray(a)){var g=[];return d.each(a,function(a){g.push(e(a))}),g}if(d.isObject(a)){var h={};return d.each(a,function(a,b){h[b]=e(a)}),h}return a};return e(c)},save:function(){var a=this.attributes,c=this.parse;this.parse=function(){return this.attributes=a,this.parse=c,this.parse.apply(this,arguments)},this.attributes=this.recursiveBeforeSave(d.clone(a));var e=b.Model.prototype.save.apply(this,arguments);return this.attributes=a,e},clear:function(a){var c=b.Model.prototype.clear.apply(this,arguments);return this._setNesting({},a),c},_triggerEvent:function(a,b){var c=Array.prototype.slice.call(b,0);c.unshift(a),this.trigger.apply(this,c)},sync:function(){return arguments[2]&&(arguments[2].instance=arguments[1]),b.Model.prototype.sync.apply(this,arguments)}});f.Model=k;var g=g||{},j=j||{},l=b.Collection.extend({selectable:!0,filterable:!0,filterableOptions:function(){return{}},selectableOptions:function(){return{}},model:f.Model,constructor:function(){var a=b.Collection.prototype.constructor.apply(this,arguments);return this.selectable&&(this.selectable=new j(this,d.result(this,"selectableOptions"))),this.filterable&&(this.filterable=new g(this,d.result(this,"filterableOptions"))),this.endpoint&&this.setEndpoint(this.endpoint),a},setEndpoint:function(a){this.url=function(){return URI(f.baseUrl+"/"+a).normalize().toString()}},parse:function(a){return a.data=a.data||{},this.filterable&&this.filterable.setTotalAmount(a.data.total||a.data.nonpagedCount||0),a.data.results},sync:function(a,c,d){if(this.filterable){var e=this.filterable.getRequestParams.apply(this.filterable,arguments);d=e}return b.Collection.prototype.sync.apply(this,[a,c,d])},replace:function(a){this.reset(a),this.trigger("replace",this)},secureEach:function(a,b){d.pluck(this.models,"cid").forEach(function(c,d){var e=this.get(c,d);a.call(b,e,d,this.models)}.bind(this))}});f.Collection=l;var g=g||{},j=j||{},m=f.Collection.extend({selectable:!1,filterable:!1,defaults:function(){return[]},parse:function(a){var b=[];return d.each(a.data,function(a){b.push({key:a.value})}),b},toJSON:function(){return this.pluck("key")},model:f.Model.extend({idAttribute:"key"}),constructor:function(){var a=f.Collection.prototype.constructor.apply(this,arguments),b=d.result(this,"defaults");return b.length>0&&d.each(b,function(a){this.add({key:a})},this),a}});f.EnumerableCollection=m;var n=function(){var a=function(a,b){return d.isUndefined(a)||null===a||""===a||0===a.length||d.isArray(a)&&0===d.compact(a).length?null:b};return{containsString:function(b,c){return a(c,{type:"containsString",fieldName:b,contains:c})},string:function(b,c){return a(c,{type:"string",fieldName:b,value:c})},and:function(a){return this.logOp(a,"AND")},nand:function(a){return this.logOp(a,"NAND")},or:function(a){return this.logOp(a,"OR")},logOp:function(a,b){return a=d.without(a,null),0===a.length?null:{type:"logOp",operation:b,filters:a}},boolean:function(b,c){return a(c,{type:"boolean",fieldName:b,value:c})},stringMap:function(b,c,d){return"%%"===d&&(d=""),a(d,{type:"stringMap",fieldName:b,value:d,key:c})},stringEnum:function(b,c){return a(c,{type:"stringEnum",fieldName:b,values:d.flatten(c)})},long:function(b,c){return a(c,{type:"long",fieldName:b,value:c})},like:function(b,c){return a(c,{type:"like",fieldName:b,like:c})},notNull:function(b){return a(!0,{type:"null",fieldName:b})},dateRange:function(b,c,d){return a(d,a(c,{type:"dateRange",fieldName:b,min:c,max:d}))}}};f.Filter=n,a.mCAP=f}(this,Backbone,$,_);